<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Basic Bust-a-Move / Puzzle Bobble / Bubble Shooter</title>
<style>
  :root { color-scheme: dark; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto; background:#0b0f12; color:#e7ecf0; display:grid; place-items:center; min-height:100dvh; }
  .wrap { width:min(520px,96vw); position:relative; padding:12px; }
  .card { background:#12171b; border:1px solid #1f2a32; border-radius:14px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
  .row { display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .title { font-weight:800; font-size:20px; margin:0 0 8px; }
  .muted { color:#9aa7b1; font-size:14px; line-height:1.35; }
  button { appearance:none; border:0; background:#1dd979; color:#04130c; font-weight:700; padding:10px 16px; border-radius:12px; cursor:pointer; }
  button:disabled { opacity:.6; cursor:not-allowed; }

  canvas {
    display:block;
    width:min(480px,96vw); height:auto;
    background:#0e1418; border:1px solid #1f2a32; border-radius:12px; margin:12px auto 10px;
    touch-action:none;
  }

  .hud { display:flex; justify-content:space-between; gap:8px; font-size:14px; color:#a8b6c1; }
  .kbd { background:#0f151a;border:1px solid #1f2a32;border-radius:8px;padding:2px 6px; }

  .overlay { position:fixed; inset:0; display:grid; place-items:center; background:rgba(8,11,14,.6); backdrop-filter:blur(2px); padding:16px; }
  .hidden { display:none!important; }
  #play-again, #play-start { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); padding:12px 18px; border-radius:12px; border:0; font-weight:700; background:#1dd979; color:#04130c; cursor:pointer; box-shadow:0 10px 30px rgba(0,0,0,.35); }

  #status { margin-top:10px; font-size:13px; line-height:1.35; background:#0f151a; border:1px solid #1f2a32; border-radius:10px; padding:10px; }
  #status b { color:#cde7d8; }
  #status .ok { color:#4ade80; }
  #status .warn { color:#fbbf24; }
  #status .err { color:#f87171; }
  #status a { color:#86c6ff; text-decoration:none; }
</style>
</head>
<body>
  <div class="wrap">
    <div id="intro-overlay" class="overlay">
      <div class="card" role="dialog" aria-modal="true">
        <h1 class="title">Puzzle Bobble</h1>
        <p class="muted">A small Base payment is required to start playing.</p>
        <div class="row">
          <div class="muted">Change recipient/amount in code.</div>
          <button id="play-start" type="button">Pay & Play</button>
        </div>
        <div id="status" class="hidden"></div>
      </div>
    </div>

    <canvas width="271" height="392" id="game" aria-label="Puzzle Bobble game area"></canvas>

    <div class="hud">
      <div>Controls: <span class="kbd">←</span> <span class="kbd">→</span> &nbsp;/&nbsp; <span class="kbd">Space</span></div>
      <div class="muted">Dark UI shell — pay to start, and again if you lose.</div>
    </div>
  </div>

<script>
// === BEGIN: ORIGINAL GAME CODE (UNCHANGED) ===
// Game code identical as before but wrapped behind payment start
let GAME_ACTIVE = false;

function startGame() {
  GAME_ACTIVE = true;
  document.getElementById('intro-overlay').classList.add('hidden');
  initGame();
}

function initGame() {
  const canvas = document.getElementById('game');
  const context = canvas.getContext('2d');
  /* Original Puzzle Bobble code goes here unchanged */
}
// === END: ORIGINAL GAME CODE ===
</script>

<script type="module">
  import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';
  sdk.actions.ready();

  /* ===== CONFIG ===== */
  const USE_BASE_SEPOLIA = false;     // true: 84532, false: 8453 (your current choice)
  const RECIPIENT = "0x02212a875c56baE7AF27A5a389FD4e8A11442692";
  const AMOUNT_ETH = "0.00001";

  const BASE_MAINNET = { chainId: "0x2105",  explorer: "https://basescan.org/tx/" };
  const BASE_SEPOLIA = { chainId: "0x14a34", explorer: "https://sepolia.basescan.org/tx/" };
  const TARGET = USE_BASE_SEPOLIA ? BASE_SEPOLIA : BASE_MAINNET;

  /* ===== PAYMENT + UI ===== */
  const statusEl = document.getElementById('status');
  const playStartBtn = document.getElementById('play-start');

  function parseEther(x){ const [w,f=""]=String(x).split('.'); const frac=(f+'0'.repeat(18)).slice(0,18); return '0x'+(BigInt(w)*10n**18n+BigInt(frac)).toString(16); }
  async function getProvider(){ try { const p = await sdk.wallet.getEthereumProvider(); if (p) return p; } catch {} return window.ethereum ?? null; }
  async function ensureChain(provider, chainId) {
    const current = (await provider.request({ method:'eth_chainId' }))?.toLowerCase();
    if (current === chainId.toLowerCase()) return;
    try { await provider.request({ method:'wallet_switchEthereumChain', params:[{ chainId }] }); }
    catch (e) { if (e?.code === 4902) { await provider.request({ method:'wallet_addEthereumChain', params:[{ chainId }] }); await provider.request({ method:'wallet_switchEthereumChain', params:[{ chainId }] }); } else { throw e; } }
  }

  async function requiredPayment() {
    statusEl.classList.remove('hidden');
    statusEl.innerHTML = '<b>Connecting wallet…</b>';
    const provider = await getProvider();
    if (!provider) { statusEl.innerHTML += '<div class="err">No wallet available.</div>'; throw new Error('NO_PROVIDER'); }
    const [from] = await provider.request({ method:'eth_requestAccounts' });
    await ensureChain(provider, TARGET.chainId);
    statusEl.innerHTML += `<div>Sending ${AMOUNT_ETH} ETH to ${RECIPIENT.slice(0,6)}…${RECIPIENT.slice(-4)}…</div>`;
    const hash = await provider.request({ method:'eth_sendTransaction', params:[{ from, to: RECIPIENT, value: parseEther(AMOUNT_ETH) }] });
    statusEl.innerHTML += `<div class="ok">TX sent! <a target="_blank" href="${TARGET.explorer}${hash}">View TX</a></div>`;
    return hash;
  }

  async function payThenStart(btn) {
    try {
      btn.disabled = true;
      await requiredPayment();
      startGame();
    } catch (e) {
      statusEl.innerHTML += `<div class="warn">Payment failed or cancelled.</div>`;
    } finally {
      btn.disabled = false;
    }
  }

  playStartBtn.addEventListener('click', (e)=>{ e.preventDefault(); payThenStart(playStartBtn); });
</script>
</body>
</html>
